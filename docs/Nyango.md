# 🐱 Nyango（ニャンゴ）ゲーム仕様書（改訂版）

## 1. 概要

* **タイトル**：Nyango（ニャンゴ）
* **ジャンル**：アクションパズル
* **プレイ人数**：1人
* **対象プラットフォーム**：iOS / Android
* **想定プレイ時間**：1プレイ 3〜5分
* **特徴**

  * PENGOをベースにした猫×カラス×犬の世界観
  * ステージはランダム生成で毎回新鮮
  * 短時間プレイ＋スコアアタック要素

---

## 2. 世界観・ストーリー

* **舞台**：街の屋根の上、港町、砂場、裏路地
* **ストーリー**：

  > 街を荒らすカラスと犬から街を守るため、猫のNyangoは毛玉を転がして戦う！
* **登場キャラ**

  * Nyango（主人公）
  * カラス（通常敵）
  * 犬（強敵、砂山を壊す）
  * 毛玉（攻撃兼ギミック）
  * 砂山（崩れるだけの障害物、ドロップ要素あり）
  * 木（外周ギミック、範囲スタン）
  * 爪とぎ（アイテム）

---

## 3. ゲームシステム

### 基本ルール

1. 毛玉を押して転がし、敵（カラス・犬）を倒す
2. 敵に接触するとライフ減少
3. 敵を全滅、または毛玉を3つそろえるとステージクリア
4. ステージごとに制限時間あり

### 主人公（猫）のアクション

* **移動**：上下左右
* **押す**：

  * 砂山 → 崩れる（攻撃には使えないが、一定確率で「爪とぎ」をドロップ）
  * 毛玉 → 一直線に転がす（攻撃可能）
  * 木 → 範囲スタン（半径2マスの敵を1秒間硬直）
* **爪とぎ使用**：取得後、猫が爪を研ぐことで次の行動に「直接攻撃」効果を付与（1回のみ有効）

---

## 4. フィールド

* 長方形のグリッド（例：16×16）
* **外周**：壁＋木（四隅を除き1マスおきに木）
* **内部**：砂山、毛玉、空白を配置
* **毛玉配置**：常にフィールドに5〜10個配置、ステージごとにランダム再配置

---

## 5. 敵キャラクター

### カラス

* 動きが速く、猫を追尾／突進
* 毛玉に当たると一撃で倒れる

### 犬

* 動きは遅い
* 砂山を壊して通路を広げる
* 毛玉を2回当てないと倒せない
* 爪とぎ攻撃でも1回で撃破可能

---

## 6. 勝敗条件

* **勝利条件**

  * 敵を全滅させる
  * または毛玉を3つ揃える
* **敗北条件**

  * ライフが0になる
  * 制限時間が尽きる

---

## 7. UI構成（縦画面）

* 上部中央：スコア
* 上部左：ライフ（ハートアイコン）
* 上部右：残り時間
* 左下：バーチャルスティック
* 右下：アクション・ダッシュボタン
* 爪とぎ所持時：右下にアイコン表示（点滅して使用可能を示す）

---

## 8. アイテム

| アイテム | 効果                              |
| ---- | ------------------------------- |
| 魚の骨  | スコアアップ                          |
| ミルク瓶 | ライフ回復                           |
| 小判   | ボーナスステージ解放                      |
| またたび | 一定時間スピードアップ                     |
| 爪とぎ  | **近接攻撃(1回)を付与**／砂山崩し時に一定確率でドロップ |

---

## 9. ステージ自動生成アルゴリズム

* **外周生成**：四隅を除き1マスおきに木を設置し、外周を壁で囲む。
* **通路骨格**：内部は迷路生成や部屋＋通路配置で骨格を作成し、可達性を担保する。
* **砂山配置**：通路率（約45〜55%）を保ちながら砂山で埋める。ただし狭い通路が連続し過ぎないよう制御。
* **毛玉配置**：常に5〜10個配置。一直線に転がせるレーンを持つ位置に置き、3揃え・4揃えが可能な配置を最低1通り保証する。
* **プレイヤー配置**：開始位置は外周木から近すぎず、複数方向に動ける通路上に設定。
* **敵配置**：

  * カラスはプレイヤーから一定距離以上の通路に配置。
  * 犬は砂山付近に配置し、壊す挙動を活かす。
* **木の実効性**：序盤から木スタンで敵を止められるよう、少なくとも1つの木に敵が侵入する導線を保証。
* **検証と再配置**：

  * Flood Fillでプレイヤーから到達率60%以上を確保。
  * 毛玉の4揃え可能性を最低1通り検証。
  * 不条件を満たさない場合は砂山・毛玉の再配置やシード再抽選を行う。

---

## 10. ステージ進行（Stage 1〜5）

* **Stage 1**：

  * 毛玉多め（8〜10個）、砂山少なめ。
  * 敵はカラスのみ。初めての毛玉攻撃と木スタンを学ぶ段階。
* **Stage 2**：

  * 犬が登場。砂山が多めに配置され、壊されて通路が広がる緊張感。
  * 毛玉数は7〜9個。
* **Stage 3**：

  * 毛玉が端や奥に偏り、通路開拓が必要になる。
  * 犬2体、カラス増加で密度が上がる。
* **Stage 4**：

  * 砂山の塊が多く、爪とぎのドロップ確率が活きやすい。
  * 敵は犬2〜3体、カラス多数で混戦。
* **Stage 5（ボス相当）**：

  * 犬＋カラスの群れ構成。外周木スタンを駆使しないと突破困難。
  * 毛玉4揃えによるチュールドロップを狙うのが攻略の鍵。

---

## 11. グラフィック仕様. グラフィック仕様

* **画面比率**：16:9（縦向き）
* **解像度**：推奨1080x1920
* **アートスタイル**：ドット絵
* **アニメーション例**

  * Nyango：歩行4F、毛玉押し4F、爪とぎ使用モーション
  * カラス：歩行2F、被弾1F
  * 犬：歩行2F、被弾2F
  * 毛玉：転がりアニメーション
  * 木：スタン発動時の点滅エフェクト
  * 爪とぎ：取得時にきらめきエフェクト

---

## 11. 音楽・効果音

* **BGM**：チップチューン＋ジャズ風
* **SE**：

  * 毛玉を押す音
  * 毛玉ヒット音
  * 木スタンの発動音
  * 砂山崩壊音
  * 爪とぎ取得音／攻撃音
  * Nyangoの鳴き声（クリア時）

---

## 12. 著作権回避ポイント

1. キャラ・音楽・背景は完全オリジナル
2. 「Pengo」「Sega」等の商標や素材を使用しない
3. ゲームルールは参考にしても、ギミック・演出は独自化

---

## 13. 爪とぎ（ドロップ＆近接攻撃）

* **ドロップ条件**：砂山を崩した際、\*\*一定確率（初期 20%）\*\*で出現（演出：砂煙→爪とぎアイコン）。
* **取得**：接触で自動取得。**所持上限1**（重ね持ち不可）。
* **UI**：画面上部に爪アイコン＋残回数（常に1 or 0）。
* **使用条件**：敵に\*\*隣接（マンハッタン距離1）\*\*し、アクション入力で発動。発動時0.2s硬直＋爪アニメ。
* **効果**：

  * **カラス**：一撃で撃破。
  * **犬**：1ダメージ（犬は合計**2ダメージ**で撃破）。
* **スコア**：近接での撃破は毛玉撃破と同値（チューニング可）。
* **その他**：

  * 使い切り（消費）／未使用のままでもステージ跨ぎで**リセット**。
  * ドロップは**10秒**で消滅（点滅予兆2秒）。
  * 毛玉3揃え中でも使用可（スタン延長などの相乗効果なし）。

### 調整パラメータ（初期案）

```txt
NAIL_DROP_RATE          = 0.20   // 爪とぎドロップ確率
NAIL_DESPAWN_MS         = 10000  // 自然消滅時間
MELEE_WINDUP_MS         = 200    // 発動前硬直
DOG_HP                  = 2      // 犬の必要ダメージ
MELEE_SCORE_CROW        = = KILL_SCORE_CROW   // 毛玉と同値
MELEE_SCORE_DOG         = = KILL_SCORE_DOG    // 毛玉と同値
```

---

## 14. チュール（毛玉4つ揃え特典）

* **ドロップ条件**：毛玉を一直線に**4つ揃えた際**、中央にチュールが出現。
* **取得**：接触で自動取得。
* **効果**：

  * 一定時間（初期 7秒間）、**無敵状態**になる。
  * 無敵中は敵に接触するとダメージを与えて撃破できる（犬は2回接触で撃破）。
  * 攻撃判定は接触フレームで即時処理（のけぞり演出付き）。
* **UI**：無敵中は画面外周を光らせる／キャラにチュールアイコンを点滅表示。
* **終了条件**：時間切れ、またはステージクリアでリセット。

### 調整パラメータ（初期案）

```txt
CHURU_INVINCIBLE_MS     = 7000   // 無敵時間
CHURU_DROP_MODE         = On4Align   // 毛玉4揃えでドロップ
INVINCIBLE_HITDOGS      = 2      // 犬は2回ヒットで撃破
```

---

## 15. ステージ自動生成アルゴリズム（核心）

**目的**：毎回新鮮さを保ちつつ、常に「遊べる盤面」を保証（到達可能性／攻撃レーン／4揃え機会／木スタン有効場面）。

### コア手順（コードレス要約）

1. **外周整備**：壁で囲い、四隅以外を1マスおきに木配置（TREE）。木は通行不可・押すと半径2の1sスタン。
2. **骨格形成**：通路の“芯”を先に作る（迷路 or 部屋＋通路）。狭路が連続し過ぎないよう幅を確保。
3. **砂山充填**：通路率が指定範囲になるよう砂山（SAND）を配置。崩せば道が開くが攻撃は不可。
4. **毛玉配置**：5〜10個を空きセルに置く。上下左右のいずれかへ**直線3セル以上**の“攻撃レーン”が続く位置を優先し、既存毛玉と**一直線かつ距離≤6**を好む（4揃えの下地）。
5. **配置の密度調整**：毛玉同士は近すぎない（距離制約）。砂山でボトルネックが生じたら緩和。
6. **スポーン**：

   * **プレイヤー**：分岐（2方向以上）を持つ通路に配置。木に近すぎない。
   * **カラス**：通路にランダム。初期距離はプレイヤーから離す。
   * **犬**：砂山隣接の通路を優先（“壊す”性格を活かす）。
7. **4揃え保証**：毛玉の並べ替え可能性を簡易検証し、最低1通りの“4直線揃え”達成ルートを確保（必要なら局所再配置）。
8. **到達検証**：砂山を障害物扱いで到達率を評価。閾値未満なら砂山を間引き、袋小路も抑制。
9. **木の有効性確認**：序盤数十秒で木スタン範囲に敵が入り得るよう、敵湧きを微調整。
10. **失敗時のやり直し**：局所再配置で解決し、無理ならシード再抽選。

### 重要な保証条件

* **到達率**：プレイヤー起点で可達セルが一定以上（例：≥60%）。
* **攻撃レーン**：毛玉からの水平/垂直レーン本数が最低値以上。
* **4揃え機会**：直線で4を揃えられる候補が少なくとも1通り。
* **木スタン有効性**：外周木を押して有効な場面が初期から存在。

---

## 16. ステージ別パラメータ（Stage 1〜5）

| パラメータ                  | Stage1 | Stage2 | Stage3 | Stage4 | Stage5 |
| ---------------------- | -----: | -----: | -----: | -----: | -----: |
| 通路率 `pPass`（目安）        |   0.55 |   0.50 |   0.48 |   0.46 |   0.44 |
| 毛玉数（開始時）               |   8–10 |    7–9 |    6–8 |    6–8 |    5–7 |
| 最小レーン長 `minLaneLen`    |      3 |      3 |      4 |      4 |      4 |
| カラス数                   |      4 |      6 |      7 |      8 |      9 |
| 犬数                     |      0 |      1 |      2 |      2 |      3 |
| 到達率下限 `minReachRate`   |   0.65 |   0.60 |   0.60 |   0.60 |   0.58 |
| 狭路連続の上限 `maxNarrowLen` |      短 |      中 |      中 |      長 |      長 |
| 木スタン有効性                | 初期から確保 |     確保 |     確保 |  再調整強め |  再調整強め |
| 爪とぎ出現体感                | やや出やすい |     標準 |     標準 |  やや控えめ |    控えめ |
| チュール機会（4揃え）            |      高 |      中 |      中 |      中 |    低〜中 |

> 備考：
>
> * 後半ほど砂山密度が上がるため、到達率検証とボトルネック緩和の再試行回数を増やす。
> * 犬の数が増えるため、毛玉レーン長の下限を上げつつ、木スタンが有効になるよう敵湧きを外周寄りに調整。
> * 爪とぎ（砂山ドロップ）は**体感**が暴れないよう、通路率×ドロップ率の“上限”を内部でクリップ。
